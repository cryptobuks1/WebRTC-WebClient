<template>
      <md-content class="md-elevation-24 md-layout-item md-xlarge-size-50 md-large-size-60 md-big-size-70 md-medium-size-80 md-small-size-90 md-xsmall-size-100" >
        <div id="controlls">
          <md-field class="md-layout-item md-xlarge-size-50 md-large-size-50 md-medium-size-50 md-small-size-100">
            <md-input  id="username" readonly="readonly" placeholder="ID (auto generated)"/>
          </md-field>
          <md-field class="md-layout-item md-xlarge-size-50 md-large-size-50 md-medium-size-50 md-small-size-100">
            <md-input  id="username-to-call" placeholder="ID to call" />
          </md-field>
          <md-field class="md-layout-item md-xlarge-size-50 md-large-size-50 md-medium-size-50 md-small-size-100">
            <md-select id="videoinput" v-model="videoSelected" placeholder="Video input">
              <md-option v-for="item in optionsVideo" v-bind:key="item.value" :value="item.value">{{item.text}}</md-option>
            </md-select>
          </md-field>
          <md-field class="md-layout-item md-xlarge-size-50 md-large-size-50 md-medium-size-50 md-small-size-100">
            <md-select id="audioinput" v-model="audioSelected" placeholder="Audio input">
              <md-option v-for="item in optionsAudio" v-bind:key="item.value" :value="item.value"  :selected="true">{{item.text}}</md-option>
            </md-select>
          </md-field>
        </div>
        <md-field class="float-left md-layout-item md-xlarge-size-50 md-large-size-50 md-medium-size-50 md-small-size-50 md-xsmall-size-50">
          <video  id="local"  autoplay poster="/assets/stream.png"></video>
        </md-field>
        <md-field class="float-left md-layout-item md-xlarge-size-50 md-large-size-50 md-medium-size-50 md-small-size-50 md-xsmall-size-50">
          <video  id="remote" autoplay poster="/assets/stream.png"></video>
        </md-field>
        <md-field class="md-layout-item md-xlarge-size-100 md-large-size-100 md-medium-size-100">
          <md-input  id="state" readonly="readonly"  placeholder="Connection status" />
        </md-field>

        <div style="clear:both"></div>
        <md-button id="login"     class="md-layout-item md-xlarge-size-20">Reister</md-button>
        <md-button id="call-make" class="md-layout-item md-xlarge-size-20">Dial</md-button>
      </md-content>
</template>

<style lang="scss">
#controlls .md-layout-item {
  float:left;
}
</style>
<script>
export default {
    data: () => ({
        audioSelected: '',
        optionsAudio: [],
        videoSelected: '',
        optionsVideo: []
      }),
      mounted() {
          let init = () => {
          let connection        = null
          let otherUsername     = null
          let local             = document.querySelector('video#local')
          let remote            = document.querySelector('video#remote')
          let remoteName        = document.querySelector('#username-to-call')
          let state             = document.querySelector('#state')
          let btnLogin          = document.querySelector('button#login')
          let callBtn           = document.querySelector('button#call-make')
          let hash              = window.location.hash.substr(1)
          let d                 = (e) => {
            /* eslint-disable no-console */
            console.log(e);
            /* eslint-enable no-console */
          }
          let ws                = new WebSocket('wss://seqr.link:3001/socket')
          let connectionState   = (conn)        => { return (conn.connectionState || conn.iceConnectionState) }
          let checkState        = (conn)        => { return  ['new','connecting','failed','disconnected'].includes(connectionState(conn)) }
          let error             = error         => { d(error) }
          let answer            = answr         => { connection.setLocalDescription(answr); sendMessage({type: 'answer',answer: answr}) }
          let offer             = ofr           => { sendMessage({ type: 'offer', offer: ofr }); connection.setLocalDescription(ofr)}
          let makeCall          = ()            => { otherUsername = remoteName.value; connection.createOffer( offer,error ) }
          let sendMessage       = message       => { message.otherUsername = otherUsername; ws.send(JSON.stringify(message)) }
          let login             = ()            => { sendMessage({type: 'login',uuid: hash}) }
          let _close            = ()            => { }
          let _answer           = data          => { if( checkState(connection) ) connection.setRemoteDescription(new RTCSessionDescription(data.answer)) }
          let _candidate        = data          => { if( checkState(connection) ) connection.addIceCandidate     (new RTCIceCandidate(data.candidate))    }
          let _offer            = data          => {
              if(checkState(connection)){
                  otherUsername = data.username
                  connection.setRemoteDescription(new RTCSessionDescription(data.offer))
                  connection.createAnswer(answer,error)        
              }
          }
          let _login            = data          => {
              local.volume = 0
              local.style.visibility = 'visible'
              document.querySelector('#username').value = data.success
              createConnection()
          }
          let createConnection  = async ()            => {
                  connection = new RTCPeerConnection({ iceServers: [{ urls: ['stun:seqr.link:3478'] }] })
              let audio = ( this.audioSelected === 'none' ? false : { deviceId: { exact: this.audioSelected }} )
              let video = ( this.videoSelected === 'none' ? false : { deviceId: { exact: this.videoSelected}} )
              let localStream = await navigator.mediaDevices.getUserMedia({video: video,audio: audio })
              local.srcObject = localStream
              connection.addStream(localStream)
              if( video ) connection.addTransceiver('video',{currentDirection:'sendrecv'})
              if( audio ) connection.addTransceiver('audio',{currentDirection:'sendrecv'})
              connection.ontrack          = event  => { remote.srcObject = event.stream }
              connection.onaddstream      = connection.ontrack
              connection.onicecandidate   = event  => { if (event.candidate) sendMessage({ type: 'candidate', candidate: event.candidate }) }
              connection.onconnectionstatechange      = () => { state.value = connectionState(connection) }
              connection.oniceconnectionstatechange   = connection.onconnectionstatechange
              state.value = connectionState(connection)
          }

          let handlers          =                   {_login:_login,_offer:_offer,_answer:_answer,_candidate:_candidate,_close:_close}
          ws.onopen               = ()             => { d('Connected to the signaling server') }
          ws.onmessage            = msg            => { let data = JSON.parse(msg.data); handlers[data.type](data) }
          ws.onerror              = error
          btnLogin    .addEventListener('click', login )
          callBtn.addEventListener('click', makeCall )
//          ws.onopen = login
          let defaultVideo = {text: 'No video selected', value: 'none'}
          let defaultAudio = {text: 'No audio selected', value: 'none'}
          this.optionsVideo.push(defaultVideo)
          this.optionsAudio.push(defaultAudio)
          navigator.mediaDevices.enumerateDevices().then(dev => {
              dev.map((dev) => { 
                if(dev.kind === 'videoinput') this.optionsVideo.push({text: dev.label, value: dev.deviceId})
                if(dev.kind === 'audioinput') this.optionsAudio.push({text: dev.label, value: dev.deviceId})
              })
              this.videoSelected = defaultVideo.value
              this.videoSelected = this.optionsVideo[1].value
              this.audioSelected = this.optionsAudio[1].value
            }
          )
        }
        init()
    }
}
</script>

